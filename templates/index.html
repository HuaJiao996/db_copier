<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL 数据库复制工具</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        .form-group { margin-bottom: 1rem; }
        .card { margin-bottom: 1rem; }
        #logArea { height: 200px; overflow-y: auto; }
        .config-actions { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div id="initialData" data-tables='{{ config.tables|tojson|safe if config.tables else "[]" }}' style="display:none;"></div>
    <div class="container mt-4">
        <h1 class="mb-4">PostgreSQL 数据库复制工具</h1>
        
        <!-- 配置管理 -->
        <div class="config-actions">
            <div class="input-group">
                <input type="text" class="form-control" id="configName" placeholder="配置名称">
                <button class="btn btn-primary" onclick="saveAsNewConfig()">保存为新配置</button>
                <button class="btn btn-secondary" onclick="showConfigList()">加载配置</button>
            </div>
        </div>
        
        <form id="configForm">
            <!-- SSH配置 -->
            <div class="card">
                <div class="card-header">
                    SSH 配置
                    <div class="float-end">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="testSSHConnection()">
                            测试连接
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>主机地址</label>
                                <input type="text" class="form-control" name="ssh.host" value="{{ config.ssh.host }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>端口</label>
                                <input type="number" class="form-control" name="ssh.port" value="{{ config.ssh.port }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>用户名</label>
                                <input type="text" class="form-control" name="ssh.username" value="{{ config.ssh.username }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>认证方式</label>
                                <select class="form-control" id="sshAuthType" onchange="toggleSSHAuth()">
                                    <option value="key">密钥认证</option>
                                    <option value="password">密码认证</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="sshKeyAuth">
                        <div class="form-group">
                            <label>密钥文件路径</label>
                            <input type="text" class="form-control" name="ssh.private_key_path" value="{{ config.ssh.private_key_path }}">
                        </div>
                    </div>
                    <div id="sshPasswordAuth" style="display:none;">
                        <div class="form-group">
                            <label>密码</label>
                            <input type="password" class="form-control" name="ssh.password">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据库配置 -->
            <div class="row">
                <!-- 源数据库 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            源数据库配置
                            <div class="float-end">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="testDBConnection('source')">
                                    测试连接
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>主机</label>
                                <input type="text" class="form-control" name="source_db.host" value="{{ config.source_db.host }}">
                            </div>
                            <div class="form-group">
                                <label>端口</label>
                                <input type="number" class="form-control" name="source_db.port" value="{{ config.source_db.port }}">
                            </div>
                            <div class="form-group">
                                <label>数据库名</label>
                                <input type="text" class="form-control" name="source_db.database" value="{{ config.source_db.database }}">
                            </div>
                            <div class="form-group">
                                <label>用户名</label>
                                <input type="text" class="form-control" name="source_db.username" value="{{ config.source_db.username }}">
                            </div>
                            <div class="form-group">
                                <label>密码</label>
                                <input type="password" class="form-control" name="source_db.password" value="{{ config.source_db.password }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 目标数据库 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            目标数据库配置
                            <div class="float-end">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="testDBConnection('target')">
                                    测试连接
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>主机</label>
                                <input type="text" class="form-control" name="target_db.host" value="{{ config.target_db.host }}">
                            </div>
                            <div class="form-group">
                                <label>端口</label>
                                <input type="number" class="form-control" name="target_db.port" value="{{ config.target_db.port }}">
                            </div>
                            <div class="form-group">
                                <label>数据库名</label>
                                <input type="text" class="form-control" name="target_db.database" value="{{ config.target_db.database }}">
                            </div>
                            <div class="form-group">
                                <label>用户名</label>
                                <input type="text" class="form-control" name="target_db.username" value="{{ config.target_db.username }}">
                            </div>
                            <div class="form-group">
                                <label>密码</label>
                                <input type="password" class="form-control" name="target_db.password" value="{{ config.target_db.password }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 表配置 -->
            <div class="card">
                <div class="card-header">
                    表配置
                    <button type="button" class="btn btn-sm btn-primary float-end" onclick="fetchTables()">
                        从数据库获取表
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary float-end me-2" onclick="addTableConfig()">
                        手动添加表
                    </button>
                </div>
                <div class="card-body">
                    <div id="tablesContainer">
                        <!-- 表配置将动态添加到这里 -->
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="mb-4">
                <button type="button" class="btn btn-primary" onclick="saveConfig()">保存当前配置</button>
                <button type="button" class="btn btn-success" onclick="startCopy()">开始复制</button>
            </div>
        </form>

        <!-- 日志区域 -->
        <div class="card">
            <div class="card-header">运行日志</div>
            <div class="card-body">
                <pre id="logArea" class="bg-light p-3"></pre>
            </div>
        </div>
    </div>

    <!-- 配置列表模态框 -->
    <div class="modal fade" id="configListModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="configList">
                        <!-- 配置列表将动态添加到这里 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 表选择模态框 -->
    <div class="modal fade" id="tableSelectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择要复制的表</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="tableSearchInput" placeholder="搜索表名...">
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAllTables">
                                    </th>
                                    <th>表名</th>
                                    <th>行数</th>
                                    <th>列数</th>
                                </tr>
                            </thead>
                            <tbody id="tableList"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmTableSelection()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentTaskId = null;
        let statusCheckInterval = null;
        let tableSelectModal = null;
        let configListModal = null;
        let availableTables = [];
        let initialTables = JSON.parse(document.getElementById('initialData').getAttribute('data-tables'));

        // 页面加载完成后初始化
        $(document).ready(function() {
            // 初始化模态框
            tableSelectModal = new bootstrap.Modal(document.getElementById('tableSelectModal'));
            configListModal = new bootstrap.Modal(document.getElementById('configListModal'));
            
            // 加载已有的表配置
            initialTables.forEach(function(table) {
                addTableConfig(table);
            });

            // 表搜索功能
            $('#tableSearchInput').on('input', function() {
                filterTables($(this).val());
            });

            // 全选/取消全选
            $('#selectAllTables').change(function() {
                $('#tableList input[type="checkbox"]').prop('checked', $(this).prop('checked'));
            });
        });

        // 切换SSH认证方式
        function toggleSSHAuth() {
            const authType = $('#sshAuthType').val();
            if (authType === 'key') {
                $('#sshKeyAuth').show();
                $('#sshPasswordAuth').hide();
            } else {
                $('#sshKeyAuth').hide();
                $('#sshPasswordAuth').show();
            }
        }

        // 测试SSH连接
        function testSSHConnection() {
            const config = getFormData();
            $.ajax({
                url: '/test_ssh',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(config.ssh),
                success: function(response) {
                    if (response.status === 'success') {
                        alert('SSH连接成功');
                    } else {
                        alert('SSH连接失败: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('SSH连接测试失败: ' + error);
                }
            });
        }

        // 测试数据库连接
        function testDBConnection(type) {
            const config = getFormData();
            $.ajax({
                url: '/test_db_connection',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    type: type,
                    config: config[type + '_db']
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        alert('数据库连接成功');
                    } else {
                        alert('数据库连接失败: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('数据库连接测试失败: ' + error);
                }
            });
        }

        // 显示配置列表
        function showConfigList() {
            $.get('/list_configs', function(response) {
                if (response.status === 'success') {
                    const configList = $('#configList');
                    configList.empty();
                    
                    response.configs.forEach(function(config) {
                        const item = $('<button type="button">')
                            .addClass('list-group-item list-group-item-action')
                            .text(config.name)
                            .click(function() {
                                loadConfig(config.id);
                            });
                        configList.append(item);
                    });
                    
                    configListModal.show();
                } else {
                    alert('获取配置列表失败: ' + response.message);
                }
            });
        }

        // 加载配置
        function loadConfig(configId) {
            $.get('/load_config/' + configId, function(response) {
                if (response.status === 'success') {
                    // 更新表单数据
                    const config = response.config;
                    
                    // 更新SSH配置
                    $('input[name="ssh.host"]').val(config.ssh.host);
                    $('input[name="ssh.port"]').val(config.ssh.port);
                    $('input[name="ssh.username"]').val(config.ssh.username);
                    $('input[name="ssh.private_key_path"]').val(config.ssh.private_key_path);
                    
                    // 更新源数据库配置
                    $('input[name="source_db.host"]').val(config.source_db.host);
                    $('input[name="source_db.port"]').val(config.source_db.port);
                    $('input[name="source_db.database"]').val(config.source_db.database);
                    $('input[name="source_db.username"]').val(config.source_db.username);
                    $('input[name="source_db.password"]').val(config.source_db.password);
                    
                    // 更新目标数据库配置
                    $('input[name="target_db.host"]').val(config.target_db.host);
                    $('input[name="target_db.port"]').val(config.target_db.port);
                    $('input[name="target_db.database"]').val(config.target_db.database);
                    $('input[name="target_db.username"]').val(config.target_db.username);
                    $('input[name="target_db.password"]').val(config.target_db.password);
                    
                    // 更新表配置
                    $('#tablesContainer').empty();
                    config.tables.forEach(function(table) {
                        addTableConfig(table);
                    });
                    
                    configListModal.hide();
                } else {
                    alert('加载配置失败: ' + response.message);
                }
            });
        }

        // 保存为新配置
        function saveAsNewConfig() {
            const name = $('#configName').val().trim();
            if (!name) {
                alert('请输入配置名称');
                return;
            }
            
            const config = getFormData();
            config.name = name;
            
            $.ajax({
                url: '/save_config',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(config),
                success: function(response) {
                    if (response.status === 'success') {
                        alert('配置已保存');
                        $('#configName').val('');
                    } else {
                        alert('保存失败: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('保存失败: ' + error);
                }
            });
        }

        // 获取表单数据
        function getFormData() {
            const formData = {};
            const inputs = $('#configForm').find('input');
            
            inputs.each(function() {
                const name = $(this).attr('name');
                if (!name) return;
                
                const value = $(this).val();
                const nameParts = name.split('.');
                
                let current = formData;
                for (let i = 0; i < nameParts.length - 1; i++) {
                    if (!current[nameParts[i]]) {
                        current[nameParts[i]] = {};
                    }
                    current = current[nameParts[i]];
                }
                
                current[nameParts[nameParts.length - 1]] = value;
            });
            
            // 获取表配置
            formData.tables = [];
            $('#tablesContainer .table-config').each(function() {
                const tableConfig = {
                    name: $(this).find('input[name="table_name"]').val(),
                    columns: [],
                    mask_rules: []
                };
                
                // 获取列配置
                const columnsStr = $(this).find('textarea[name="columns"]').val();
                if (columnsStr.trim()) {
                    tableConfig.columns = columnsStr.split('\n').map(c => c.trim()).filter(c => c);
                }
                
                // 获取脱敏规则
                const maskRulesStr = $(this).find('textarea[name="mask_rules"]').val();
                if (maskRulesStr.trim()) {
                    try {
                        tableConfig.mask_rules = JSON.parse(maskRulesStr);
                    } catch (e) {
                        console.error('解析脱敏规则失败:', e);
                    }
                }
                
                formData.tables.push(tableConfig);
            });
            
            return formData;
        }

        // 保存配置
        function saveConfig() {
            const config = getFormData();
            
            $.ajax({
                url: '/save_config',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(config),
                success: function(response) {
                    if (response.status === 'success') {
                        alert('配置已保存');
                    } else {
                        alert('保存失败: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('保存失败: ' + error);
                }
            });
        }

        // 开始复制
        function startCopy() {
            const config = getFormData();
            
            $.ajax({
                url: '/start_copy',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(config),
                success: function(response) {
                    if (response.status === 'success') {
                        currentTaskId = response.task_id;
                        startStatusCheck();
                        $('#logArea').empty();
                    } else {
                        alert('启动失败: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('启动失败: ' + error);
                }
            });
        }

        // 检查任务状态
        function startStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(function() {
                if (!currentTaskId) return;
                
                $.get('/task_status/' + currentTaskId, function(response) {
                    $('#logArea').append(response.message + '\n');
                    
                    if (response.status === 'completed' || response.status === 'failed') {
                        clearInterval(statusCheckInterval);
                        currentTaskId = null;
                    }
                });
            }, 1000);
        }

        // 从数据库获取表
        function fetchTables() {
            const config = getFormData();
            
            $.ajax({
                url: '/fetch_tables',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(config),
                success: function(response) {
                    if (response.status === 'success') {
                        availableTables = response.tables;
                        showTableSelectModal();
                    } else {
                        alert('获取表失败: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('获取表失败: ' + error);
                }
            });
        }

        // 显示表选择模态框
        function showTableSelectModal() {
            updateTableList();
            tableSelectModal.show();
        }

        // 更新表列表
        function updateTableList(searchText = '') {
            const tableList = $('#tableList');
            tableList.empty();
            
            availableTables.forEach(function(table) {
                if (!searchText || table.name.toLowerCase().includes(searchText.toLowerCase())) {
                    const row = $('<tr>');
                    row.append($('<td>').append($('<input type="checkbox">').val(table.name)));
                    row.append($('<td>').text(table.name));
                    row.append($('<td>').text(table.rows));
                    row.append($('<td>').text(table.columns.length));
                    tableList.append(row);
                }
            });
        }

        // 过滤表
        function filterTables(searchText) {
            updateTableList(searchText);
        }

        // 确认表选择
        function confirmTableSelection() {
            const selectedTables = $('#tableList input[type="checkbox"]:checked').map(function() {
                const tableName = $(this).val();
                const tableInfo = availableTables.find(t => t.name === tableName);
                return {
                    name: tableName,
                    columns: tableInfo.columns,
                    mask_rules: []
                };
            }).get();
            
            selectedTables.forEach(function(table) {
                addTableConfig(table);
            });
            
            tableSelectModal.hide();
        }

        // 添加表配置
        function addTableConfig(tableConfig = null) {
            const container = $('#tablesContainer');
            const tableDiv = $('<div>').addClass('card mb-3 table-config');
            
            const cardBody = $('<div>').addClass('card-body');
            
            // 表名
            const nameGroup = $('<div>').addClass('form-group');
            nameGroup.append($('<label>').text('表名'));
            const nameInput = $('<input type="text">').addClass('form-control')
                .attr('name', 'table_name')
                .val(tableConfig ? tableConfig.name : '');
            nameGroup.append(nameInput);
            
            // 列配置
            const columnsGroup = $('<div>').addClass('form-group mt-2');
            columnsGroup.append($('<label>').text('列配置（每行一个，留空表示全部）'));
            const columnsText = $('<textarea>').addClass('form-control')
                .attr('name', 'columns')
                .attr('rows', '3')
                .val(tableConfig ? tableConfig.columns.join('\n') : '');
            columnsGroup.append(columnsText);
            
            // 脱敏规则
            const maskGroup = $('<div>').addClass('form-group mt-2');
            maskGroup.append($('<label>').text('脱敏规则（JSON格式）'));
            const maskText = $('<textarea>').addClass('form-control')
                .attr('name', 'mask_rules')
                .attr('rows', '3')
                .val(tableConfig ? JSON.stringify(tableConfig.mask_rules, null, 2) : '[]');
            maskGroup.append(maskText);
            
            // 删除按钮
            const deleteBtn = $('<button type="button">')
                .addClass('btn btn-danger mt-2')
                .text('删除')
                .click(function() {
                    tableDiv.remove();
                });
            
            cardBody.append(nameGroup, columnsGroup, maskGroup, deleteBtn);
            tableDiv.append(cardBody);
            container.append(tableDiv);
        }
    </script>
</body>
</html> 